#!/bin/sh
run() {
  if ! busybox mount -o ro,noatime,nosuid,nodev,exec /dev/mtdblock1 /cartridge; then
    >&2 echo "[RIVOS] Failed to mount cartridge filesystem."
    return 1
  fi
  local STATUS
  local EXE=$(busybox find /cartridge -maxdepth 1 -type f -executable -print -quit)
  if ! [[ $EXE =~ ^[-_./a-zA-Z0-9]+$ ]]; then
    >&2 echo "[RIVOS] Invalid executable filename \"$EXE\"."
    return 1
  fi
  if [[ -x "$EXE" ]]; then
    echo "[RIVOS] Unpacking rivlog..."
    if ! unpack-rivlog </dev/mtdblock2 >/run/eventlog; then
      >&2 echo "[RIVOS] Unable to unpack rivlog."
      return 1
    fi
    echo "[RIVOS] Running cartridge executable:" "$EXE" "$@"
    if ! truncate -s 0 /run/iocard; then
      >&2 echo "[RIVOS] Unable to create iocard."
      return 1
    fi
    BWRAPBOX_VERIFY_LIMITS=y \
    BWRAPBOX_FLAGS="--setenv RIV_EVENTLOG_FD 3 --setenv RIV_IOCARD_FD 4" \
      bwrapbox-run "$EXE" "$@" 3</run/eventlog 4<>/run/iocard
    STATUS=$?
    sync # flush iocard
    echo "==== BEGIN VERIFY OUTCARD ===="
    cat /run/iocard
    echo
    echo "==== END VERIFY OUTCARD ===="
    echo "[RIVOS] Cartridge finished with status $STATUS"
    rm -f /run/eventlog /run/iocard
  else
    >&2 echo "[RIVOS] No executable file found in cartridge."
    STATUS=1
  fi
  busybox umount /cartridge
  return $STATUS
}
# run cartridge
run "$@" &
CARTRIDGE_PID=$!
# wait cartridge
wait $CARTRIDGE_PID
